#!/bin/bash
set -euo pipefail

# Terminal color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# GitHub Configuration
GITHUB_RAW="https://raw.githubusercontent.com"
GITHUB_USER="xenvoid404"
GITHUB_REPO="autoscript-tunneling"
GITHUB_REPO_BRANCH="master"
GITHUB_RAW_REPO="${GITHUB_RAW}/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_REPO_BRANCH}"

# Install and configure Xray core
install_xray() {
    print_info "Installing Xray core..."
    
    # Install official Xray release
    print_info "Downloading and installing Xray..."
    if ! bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u root; then
        print_error "Failed to install Xray"
        exit 1
    fi

    # Setup custom Xray configuration layers
    print_info "Configuring Xray layers..."
    mkdir -p /etc/default/layers
    if ! curl -L -o /tmp/xray-layers.zip "${GITHUB_RAW_REPO}/xray/layers.zip"; then
        print_error "Failed to download Xray layers"
        exit 1
    fi
    unzip -q /tmp/xray-layers.zip -d /etc/default/layers
    rm -f /tmp/xray-layers.zip

    # Download networking components
    print_info "Setting up networking components..."
    download_component "ws-epro" "/usr/local/bin/ws-epro" true
    download_component "xray/tunws.conf" "/usr/local/bin/tunws.conf" false
    download_component "xray/tunws.service" "/etc/systemd/system/tunws.service" false

    # Configure systemd services
    print_info "Setting up systemd services..."
    for svc in spectrum quantix cipheron; do
        download_component "xray/${svc}.service" "/etc/systemd/system/${svc}.service" false
        systemctl enable "${svc}.service" --now
    done

    # Reload systemd and clean up
    systemctl daemon-reload
    
    print_success "Xray core installation completed successfully"
}

# Helper function to download components
download_component() {
    local component=$1
    local destination=$2
    local executable=$3
    
    if ! curl -sS "${GITHUB_RAW_REPO}/${component}" -o "${destination}"; then
        print_error "Failed to download ${component}"
        exit 1
    fi
    
    if [ "$executable" = true ]; then
        chmod +x "${destination}"
    else
        chmod 644 "${destination}"
    fi
}

# Execute installation
install_xray
rm -rf -- "$0"