#!/bin/bash
set -euo pipefail

# Terminal color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# GitHub Configuration
GITHUB_RAW="https://raw.githubusercontent.com"
GITHUB_USER="xenvoid404"
GITHUB_REPO="autoscript-tunneling"
GITHUB_REPO_BRANCH="master"
GITHUB_RAW_REPO="${GITHUB_RAW}/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_REPO_BRANCH}"

# Domain configuration
DOMAIN=${DOMAIN:-$(cat /etc/domain 2>/dev/null || true)}
if [ -z "${DOMAIN:-}" ]; then
    print_error "DOMAIN tidak ditemukan di environment maupun /etc/domain"
    exit 1
fi

# Configure Dropbear SSH server
setup_dropbear() {
    print_info "Configuring Dropbear SSH server..."
    sleep 1
    
    curl -sS "${GITHUB_RAW_REPO}/ssh/dropbear" -o /etc/default/dropbear
    chmod 644 /etc/default/dropbear
    print_success "Dropbear configuration completed"
}

# Install and configure OpenVPN
setup_openvpn() {
    clear
    print_info "Installing OpenVPN server..."
    sleep 2

    # Clean and prepare directory structure
    rm -rf /etc/openvpn
    mkdir -p /etc/openvpn
    
    # Download and extract OpenVPN configuration
    print_info "Downloading OpenVPN configuration..."
    curl -sS "${GITHUB_RAW_REPO}/openvpn/ovpn.zip" -o /etc/openvpn/ovpn.zip
    unzip /etc/openvpn/ovpn.zip -d /etc/openvpn/ >/dev/null 2>&1
    rm -f /etc/openvpn/ovpn.zip

    # Configure OpenVPN services
    print_info "Setting up OpenVPN services..."
    mkdir -p /usr/lib/openvpn
    cp /usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so /usr/lib/openvpn/
    
    sed -i 's/#AUTOSTART="all"/AUTOSTART="all"/g' /etc/default/openvpn
    
    systemctl enable --now openvpn-server@server-tcp-1194
    systemctl enable --now openvpn-server@server-udp-25000
    systemctl restart openvpn

    # Configure network settings
    echo 1 > /proc/sys/net/ipv4/ip_forward
    sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf

    # Create client configuration files
    create_client_configs

    # Clean up installation script
    rm -f "$0"
    print_success "OpenVPN installation completed successfully"
}

# Create OpenVPN client configuration files
create_client_configs() {
    print_info "Generating client configuration files..."
    
    # TCP 80 Configuration
    cat > /etc/openvpn/myvpn-tcp-80.ovpn <<-END
client
dev tun
proto tcp
remote $DOMAIN 80
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
verify-x509-name server name
auth-user-pass
comp-lzo
verb 3
redirect-gateway def1
script-security 2
cipher AES-256-CBC
auth SHA256
END

    # UDP 25000 Configuration
    cat > /etc/openvpn/myvpn-udp-25000.ovpn <<-END
client
dev tun
proto udp
remote $DOMAIN 25000
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
verify-x509-name server name
auth-user-pass
comp-lzo
verb 3
redirect-gateway def1
script-security 2
cipher AES-256-CBC
auth SHA256
END

    # SSL 443 Configuration
    cat > /etc/openvpn/myvpn-ssl-443.ovpn <<-END
client
dev tun
proto tcp
remote $DOMAIN 443
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
verify-x509-name server name
auth-user-pass
comp-lzo
verb 3
redirect-gateway def1
script-security 2
cipher AES-256-CBC
auth SHA256
END

    # Add CA certificates to configs
    add_ca_certificates

    # Make configs available via web
    cp /etc/openvpn/*.ovpn /var/www/html/
    print_success "Client configuration files generated"
}

# Add CA certificates to client configs
add_ca_certificates() {
    print_info "Adding CA certificates to client configs..."
    
    for config in /etc/openvpn/myvpn-*.ovpn; do
        echo -e "\n<ca>" >> "$config"
        cat /etc/openvpn/server/ca.crt >> "$config"
        echo "</ca>" >> "$config"
    done
}

# Execute functions
setup_dropbear
setup_openvpn