#!/bin/bash

# Terminal color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Main certificate installation function
install_certificates() {
    clear
    print_info "Configuring SSL/TLS certificates..."
    
    # Create certificate directory
    mkdir -p /etc/certificates
    if [ $? -ne 0 ]; then
        print_error "Failed to create certificates directory"
        exit 1
    fi

    # Install acme.sh client
    print_info "Installing ACME client (acme.sh)..."
    curl -s https://get.acme.sh | sh >/dev/null 2>&1
    if [ $? -ne 0 ]; then
        print_error "Failed to install acme.sh"
        exit 1
    fi

    # Initialize acme.sh environment
    cd ~/.acme.sh || exit
    print_info "Configuring certificate authority..."
    ./acme.sh --upgrade --auto-upgrade >/dev/null 2>&1
    ./acme.sh --set-default-ca --server letsencrypt >/dev/null 2>&1
    ./acme.sh --register-account -m yuivpnstore@gmail.com >/dev/null 2>&1

    # Issue new certificate
    print_info "Requesting new certificate for $DOMAIN..."
    if ! ./acme.sh --issue -d "$DOMAIN" --standalone -k ec-256 --force >/dev/null 2>&1; then
        print_error "Certificate issuance failed"
        exit 1
    fi

    # Install certificates
    print_info "Installing certificates..."
    ./acme.sh --installcert -d "$DOMAIN" \
        --fullchainpath /etc/certificates/fullchain.crt \
        --keypath /etc/certificates/private.key \
        --ecc >/dev/null 2>&1

    # Secure certificate files
    chmod 600 /etc/certificates/*
    chown nobody:nogroup /etc/certificates/*

    # Cleanup
    print_info "Performing cleanup..."
    rm -rf ~/.acme.sh >/dev/null 2>&1
    
    print_success "SSL/TLS certificates successfully configured for $DOMAIN"
    rm -f "$0"
}

# Execute main function
install_certificates